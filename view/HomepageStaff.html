<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <title>HOMEPAGE Staff</title>
    <style>
        .card-body {
            display: grid;
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
            padding: 10px;
        }

        .card {
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .button-status {
            width: calc(100% - 10px);
            /* Réduire la largeur pour inclure une marge de 10px à gauche et à droite */
            height: 40px;
            margin: 5px;
            /* Espacement autour du bouton */
            padding: 5px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            color: white !important;
            /* Force la couleur du texte à rester blanche */
            font-size: 16px;
            cursor: pointer;
            /* Ajoute la propriété border-radius pour rendre les boutons arrondis */
            border-radius: 10px;
            /* Supprime toute transition */
            transition: none !important;
        }

        .card-body .button-status {
            border-radius: 10px !important;
        }
    </style>

</head>

<body>
    <div class="ps-2 navbar bg-dark " style="background-image: url('/public/img/homepage3.jpg');">
        <div>
            <a href="/HomepageStaff.html" class="text-white navbar ps-5">HOMEPAGE</a>
        </div>
        <div>
            <a href="/staffHistory.html" class="text-white px-4" style="text-decoration: none">History</a>
            <a href="/dashboard.html" class="text-white px-4" style="text-decoration: none">Dashboard</a>
            <button id="usernameDisplay" class="btn shadow form text-white">Loading...</button>

            <img src="/public/img/login.jpg" alt="Logo" width="60px" height="60px" class="rounded-circle shadow">
            <button class="btn shadow form text-white" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>
    <div class="border-bottom"></div>
    <div class="bg-dark rounded-5 shadow  mx-5 " style="background-image: url('/public/img/backgrond2.jpg');">
        <h4 class="p-4 mt-3 text-white  text-center mb-5  fw-bold" id="day">
            </h5>
    </div>
    <div class="d-flex flex-wrap container justify-content-end mb-4 me-3">
        <!-- ADD BUTTON MODAL -->
        <button type="button" class="btn btn-success text-white ms-2 px-4" data-bs-toggle="modal"
            data-bs-target="#addroom" data-bs-whatever="addroom" id="btnAdd">
            Add
        </button>
        <div class="modal fade" id="addroom" tabindex="-1" aria-labelledby="exampleModalLabel" style="display: none"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <!-- Title Text -->
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Add Room</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <!-- Titl 1st column -->
                                <label class="col-form-label">Room Name</label>
                                <select id="room-name" class="form-select" aria-label="room-select">
                                    <option selected>select rooms</option>
                                    <option value="1">Multimedia Room</option>
                                    <option value="2">Study Room</option>
                                    <option value="3">Reading Room</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <!-- Title 2nd column -->
                                <label for="detail-text" class="col-form-label">Details</label>
                                <textarea class="form-control" id="detail-text" data-gramm="false"
                                    wt-ignore-input="true"></textarea>
                            </div>
                            <!-- Check Box Time Slot -->
                            <div hidden class="mb-3">
                                <labelfor="time" class="col-form-label">Time</labelfor=>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="8-10" id="status_8_10"
                                            checked />
                                        <label class="form-check-label" for="flexCheckDefault">
                                            8-10 A.M.
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="10-12" id="status_10_12"
                                            checked />
                                        <label class="form-check-label" for="flexCheckDefault">
                                            10-12 A.M.
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="13-15" id="status_13_15"
                                            checked />
                                        <label class="form-check-label" for="flexCheckDefault">
                                            13-15 P.M.
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="15-17" id="status_15_17"
                                            checked />
                                        <label class="form-check-label" for="flexCheckDefault">
                                            15-17 P.M.
                                        </label>
                                    </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-success" id="insert">ADD</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- END -->
    </div>
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Edit Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="editRoomName" class="form-label">Room Name</label>
                            <input type="text" class="form-control" id="editRoomName">
                        </div>
                        <div class="mb-3">
                            <label for="editDetail" class="form-label">Details</label>
                            <textarea class="form-control" id="editDetail"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveChangesButton">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <div id="Roomslot" class="d-flex flex-wrap container justify-content-center fw-bold"></div>
    <footer class="bg-dark mt-3 pt-5 pb-3" style="background-image: url('/public/img/homepage3.jpg');"></footer>
    <script src="/public/client.js"></script>
    <script>

        // fetch('/api/protected-data')
        //     .then(response => {
        //         if (!response.ok && response.status === 401) {
        //             window.location.href = '/login'; // Redirect to login
        //         }
        //         return response.json();
        //     })
        //     .then(data => console.log(data))
        //     .catch(error => console.error('Error:', error));

        var dayElement = document.getElementById('day');
        var currentDate = new Date();
        var day = currentDate.getDate();
        var month = currentDate.getMonth() + 1;
        var year = currentDate.getFullYear();
        dayElement.textContent = day + ' / ' + month + ' / ' + year;

        window.onload = function () {
            fetch('/api/rooms')
                .then(response => response.json())
                .then(data => {
                    updateRoomCards(data);
                })
                .catch(error => console.error('Error fetching rooms:', error));
        };

        // =========== Show The Rooms ===============
        function updateRoomCards(rooms) {
            let container = document.querySelector('#Roomslot');
            rooms.forEach(room => {
                let card = document.createElement('div');
                card.className = 'card shadow mx-3 mb-5 p-3 text-center border-dark border-2';
                card.style.width = '290px';

                let card_body = document.createElement('div');
                card_body.className = 'card-body row';
                card.appendChild(card_body);

                let card_title = document.createElement('h4');
                card_title.className = 'card-title';
                card_title.textContent = room.room_name;
                card_body.appendChild(card_title);

                //Display room details
                let detail = document.createElement('p');
                detail.textContent = `Details: ${room.details} `;
                card_body.appendChild(detail);

                //Time slot
                ['status_8_10', 'status_10_12', 'status_13_15', 'status_15_17'].forEach(statusKey => {
                    let status = document.createElement('div');
                    status.className = `btn button-status ${getClassByStatus(room[statusKey])}`;
                    status.textContent = `${statusKey.split('_').join(' - ')} : ${room[statusKey]}`;
                    card_body.appendChild(status);

                    let switchContainer = document.createElement('div');
                    switchContainer.className = 'form-check form-switch p-0';

                    let switchInputContainer = document.createElement('div');
                    switchInputContainer.className = 'd-inline-flex flex-row-reverse gap-1';

                    let switchInput = document.createElement('input');
                    switchInput.className = 'form-check-input ms-0';
                    switchInput.type = 'checkbox';
                    switchInput.id = `switch_${statusKey}_${room.room_name}`;
                    switchInput.addEventListener('change', () => {
                        Enable_Disable(room, switchInput.checked, statusKey, roomId);
                    });


                    //Determine the default state of the switch based on room status
                    switchInput.checked = SetDefaultSwitch(room, statusKey);
                    switchInput.disabled = SetDisableSwitch(room, statusKey);

                    switchInputContainer.appendChild(switchInput);
                    let switchLabel = document.createElement('label');
                    switchLabel.className = 'form-check-label';
                    switchLabel.setAttribute('for', `switch_${statusKey}_${room.room_name}`);
                    switchLabel.textContent = `Enable`;

                    switchInputContainer.appendChild(switchLabel);
                    switchContainer.appendChild(switchInputContainer);
                    card_body.appendChild(switchContainer);

                });
                // Add edit button
                let editButton = document.createElement('button');
                editButton.setAttribute('type', 'button');
                editButton.className = 'btn btn-warning';
                editButton.textContent = 'Edit';
                editButton.addEventListener('click', function () {
                    // Pass the room object to the openEditModal function
                    openEditModal(room);
                });
                card_body.appendChild(editButton);

                // set defaulf switch 'ON' for FREE room
                function SetDefaultSwitch(room, statusKey) {
                    const status = room[statusKey].toLowerCase();

                    if (status === 'free') {
                        return true; // Set switch ON for Free, Reserved, or Pending status
                    }
                    else if (status === 'reserved' || status === 'pending') {
                        return true;
                    }
                    else {
                        return false; // Set switch OFF for other statuses (Disabled, etc.)
                    }
                }

                // Disable PENDING and RESERVED room
                function SetDisableSwitch(room, statusKey) {
                    const status = room[statusKey].toLowerCase();
                    if (status === 'free') {
                        return false; // Set switch ON for Free, Reserved, or Pending status
                    }
                    else if (status === 'reserved' || status === 'pending') {
                        return true;
                    }
                    else {
                        return false; // Set switch OFF for other statuses (Disabled, etc.)
                    }
                }

                function Enable_Disable(room, switchState, statusKey, roomId) {
                    // Prepare the request body
                    const requestBody = {
                        roomName: roomName,
                        roomId: roomId,
                        statuses: {
                            [statusKey]: switchState ? 'Free' : 'Disabled'
                        }
                    };

                    // Make a PUT request to update the room in the database
                    fetch(`/api/rooms/${roomName}/${roomId}/${statusKey}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to update room status');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Room status updated successfully:', data);
                            console.log(json);
                            // Optionally, update UI or perform other actions after successful update
                        })
                        .catch(error => {
                            console.error('Error updating room status:', error);
                            alert('Failed to update room status. Please try again.');
                        });
                }

                //Set COLOUR of time slot 
                function getClassByStatus(status) {
                    switch (status.toLowerCase()) {
                        case 'free':
                            return 'bg-success';
                        case 'pending':
                            return 'bg-primary';
                        case 'reserved':
                            return 'bg-warning';
                        case 'disabled':
                            return 'bg-danger';
                        default:
                            return 'bg-secondary';
                    }

                }
                container.appendChild(card);
            });
        }

        function logout() {
            fetch('/logout')
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/'; // Redirect to the login page
                    } else {
                        throw new Error('Failed to logout');
                    }
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    alert('Error logging out');
                });
        }

        function openEditModal(room) {
            // Get the modal element
            let modal = document.getElementById('editModal');

            // Populate modal with room details for editing
            let roomNameInput = modal.querySelector('#editRoomName');
            roomNameInput.value = room.room_name;
            let detailTextarea = modal.querySelector('#editDetail');
            detailTextarea.value = room.details;

            // Show the modal
            let modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        }
        //Insert New Room (ADD button)
        document.addEventListener('DOMContentLoaded', function () {
            const addButton = document.getElementById('insert'); // Get the ADD button inside the modal

            addButton.addEventListener('click', function () {
                const roomName = document.getElementById('room-name').value; // Get room name input value
                const detail = document.getElementById('detail-text').value; // Get detail textarea value

                const timeSlots = []; // Array to store selected time slots

                // Check which time slots are selected
                if (document.getElementById('status_8_10').checked) {
                    timeSlots.push('8-10');
                }
                if (document.getElementById('status_10_12').checked) {
                    timeSlots.push('10-12');
                }
                if (document.getElementById('status_13_15').checked) {
                    timeSlots.push('13-15');
                }
                if (document.getElementById('status_15_17').checked) {
                    timeSlots.push('15-17');
                }
                // Create a new room object with the collected data
                const newRoom = {
                    room_name: roomName,
                    details: detail,
                    time_slots: timeSlots
                };
                // Display the collected data (for testing purposes)
                console.log('New Room Data:', newRoom);
                // Send the new room data to the backend API
                fetch('/api/add-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newRoom) // Convert newRoom object to JSON string
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to add room');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Room added successfully
                        console.log(data.message);
                        $('#addroom').modal('hide'); // Close the modal after successful addition
                        // Fetch and render rooms again to update UI
                        fetchAndRenderRooms();
                        // Optionally, display success message or update UI
                    })
                    .catch(error => {
                        // Handle error from backend or fetch request
                        console.error('Error adding room:', error);
                        // Close the modal
                        document.getElementById('addroom').modal('hide');
                    });
                location.reload();
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Add event listener for save changes button inside edit modal
            const saveChangesButton = document.getElementById('saveChangesButton');

            saveChangesButton.addEventListener('click', function () {
                // Get updated room details from modal inputs
                const updatedRoomName = document.getElementById('editRoomName').value;
                const updatedDetail = document.getElementById('editDetail').value;

                // Prepare the updated room object
                const updatedRoom = {
                    room_name: updatedRoomName,
                    details: updatedDetail
                };

                // Send HTTP request to update room details
                fetch(`/api/update-room/${room.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedRoom)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to update room');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Room updated successfully
                        console.log(data.message);
                        $('#editModal').modal('hide'); // Close the modal after successful update
                        fetchRoomsData(); // Refresh room data
                    })
                    .catch(error => {
                        console.error('Error updating room:', error);
                        // Handle error here
                    });
            });
        });

    </script>
    

</body>

</html>